# RelayCtrl-4CH 固件更新总结 v1.0.1

## 📋 更新日期：2025年8月18日

### 🔧 修复内容

#### 1. **Web界面JavaScript错误修复**
- ✅ 修复"Error: Cannot set properties of null"错误
- ✅ 移除对已删除`mqttStatus`元素的引用
- ✅ 控制面板中系统信息正常显示设备ID等信息
- ✅ 将MQTT状态改为显示Modbus地址信息

#### 2. **配置卡片界面优化**
- ✅ 统一所有配置卡片按钮底部对齐
- ✅ 改进卡片布局结构：
  - 添加`card-content`和`card-footer`分区
  - 使用flexbox实现按钮底部对齐
  - 设置统一卡片最小高度(400px)
- ✅ 修复固件升级卡片form结构

#### 3. **EEPROM配置管理完全重构** 🚀
- ✅ **完整的配置地址映射**：重新设计EEPROM地址分配
- ✅ **全面的配置项保存**：所有配置项都能持久化存储
- ✅ **智能配置加载**：启动时自动从EEPROM恢复配置

### 💾 EEPROM配置项（全部固化存储）

| 配置项 | 地址范围 | 大小 | 说明 |
|--------|----------|------|------|
| WiFi网络名称 | 0-31 | 32字节 | SSID配置 |
| WiFi密码 | 32-95 | 64字节 | 网络密码 |
| MQTT服务器 | 96-159 | 64字节 | 代理服务器地址 |
| MQTT端口 | 160-161 | 2字节 | 服务端口号 |
| MQTT主题前缀 | 162-225 | 64字节 | 主题配置 |
| MQTT用户名 | 226-257 | 32字节 | 认证用户名 |
| MQTT密码 | 258-289 | 32字节 | 认证密码 |
| 设备ID | 290-321 | 32字节 | 设备标识 |
| Web用户名 | 322-337 | 16字节 | Web认证用户名 |
| Web密码 | 338-353 | 16字节 | Web认证密码 |
| 原始TCP端口 | 354-355 | 2字节 | TCP服务端口 |
| Modbus TCP端口 | 356-357 | 2字节 | Modbus TCP端口 |
| **Modbus从机地址** | 358 | 1字节 | **串口通信地址** |
| **Modbus波特率** | 359-362 | 4字节 | **串口通信速率** |
| MQTT启用状态 | 363 | 1字节 | 服务开关 |
| TCP启用状态 | 364 | 1字节 | 服务开关 |
| Modbus TCP启用状态 | 365 | 1字节 | 服务开关 |
| Web认证启用状态 | 366 | 1字节 | 安全开关 |
| 配置有效性标志 | 511 | 1字节 | 0xAA标记 |

### 🔄 配置管理机制

#### **保存机制**
- 所有配置更改立即调用`saveConfig()`
- 数据写入EEPROM并调用`EEPROM.commit()`确保持久化
- 设置配置有效性标志(0xAA)

#### **加载机制**
- 启动时检查配置有效性标志
- 有效配置：从EEPROM完整加载所有配置项
- 无效配置：使用默认值并保存到EEPROM
- 详细的串口日志输出加载状态

#### **默认配置自动恢复**
- 首次启动或配置损坏时自动设置默认值
- 默认配置自动保存到EEPROM
- 确保设备始终有可用的配置

### 📊 技术指标

- **RAM使用**: 62.4% (51,152 字节)
- **Flash使用**: 52.4% (547,187 字节)  
- **固件大小**: 551,344 字节
- **EEPROM使用**: 367/512 字节 (71.7%)

### 🎯 用户体验提升

#### **界面优化**
- ✅ 无JavaScript错误，信息正确显示
- ✅ 统一美观的按钮布局
- ✅ 合理的Modbus地址信息展示

#### **配置管理**
- ✅ **断电保护**：所有配置断电后自动恢复
- ✅ **即时生效**：配置更改立即保存到EEPROM
- ✅ **智能恢复**：配置损坏时自动使用默认值
- ✅ **调试友好**：详细的串口日志便于故障排查

### 🔒 重要配置项固化确认

| 配置类别 | 具体项目 | 固化状态 |
|---------|----------|----------|
| **WiFi网络** | SSID、密码 | ✅ 已固化 |
| **Modbus通信** | 从机地址、波特率 | ✅ 已固化 |
| **网络服务** | TCP端口、Modbus TCP端口、服务开关 | ✅ 已固化 |
| **用户认证** | Web用户名、密码、认证开关 | ✅ 已固化 |
| **MQTT协议** | 服务器、端口、主题、认证信息、开关 | ✅ 已固化 |

### 🚀 升级建议

现在您可以：
1. **放心断电**：所有配置会自动恢复
2. **随时调整**：Modbus地址、WiFi设置等即改即存
3. **批量部署**：配置一次，断电重启后自动恢复
4. **故障诊断**：通过串口查看详细的配置加载日志

所有配置项现在都具备**工业级的断电保护**和**自动恢复**功能！
